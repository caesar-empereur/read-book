## 15章 复制
#### Redis的复制功能分为 **[同步sync](#同步sync)** 和 **[命令传播](#命令传播)** 两个操作
* **[同步](#同步)** 操作用于将从的数据库状态更新至主当前所处的数据库状态
    
    * 1 从向主发送SYNC命令
    * 2 收到SYNC命令的主执行BGSAVE命令，在后台生成一个RDB文件
    * 3 将BGSAVE命令生成的RDB文件发送给从
    * 4 从将自己的数据库状态更新至主执行BGSAVE命令时的数据库状态。


- **[命令传播](#命令传播)** 操作则用于同步操作后致主从的数据库状态出现不一致时，让主从的数据库重新回到一致状态。

    * 1 主数据变化后，会将自己执行的写命令发送给从服务器执行
    * 2 当从执行了相同的写命令之后，主从将再次回到一致状态
    * 在命令传播阶段，从会以每秒一次的频率，向主发送命令

- **[旧版同步操作缺陷](#旧版同步操作缺陷)**

    * 1 主从同步过一次后断线再进行同步，会执行上一步的同步的内容(没有必要，需要的是需要同步断线后主变动的数据)
    * 2 sync 操作耗时耗资源，需要主 执行 BGSAVE生成RDB文件，传输给从，消耗CPU内存磁盘资源
    * 3 从服务器接受到RDB文件后载入RDB文件，这时服务器会阻塞，无法处理客户端请求


> Redis从2.8版本开始，使用 **[PSYNC](#PSYNC)** 命令代替SYNC命令来执行复制时的同步操作

- **[PSYNC](#PSYNC)** 命令具有 **[完整重同步](#完整重同步)** 和 **[部分重同步](#部分重同步)** 两种模式

    * 完整重同步用于处理初次复制情况：完整重同步和SYNC命令的执行一样，都是通过让主创建并发送RDB文件
    * 部分重同步则用于处理断线后重复制情况：主从断开后, 主将断开期间主执行的写命令发送给从，从只要接收并执行这些写命令
    * **[部分重同步的原理](#部分重同步的原理)**
        * 主和从会分别维护一个复制偏移量
        * 主每次向从传播N个字节的数据，就将自己的偏移量的值加上N
        * 从每次收到主传播来的N个字节的数据时，就将自己的偏移量的值加上N
- PSYNC 命令的实现
    * PSYNC 从服务器 命令的调用方法有两种
        * 如果从服务器以前没有复制过任何主, 从在开始一次新的复制时将向主发送PSYNC -1
        * 如果从已经复制过某个主，那么从在开始新的复制时将向主发送PSYNC ＜runid＞ ＜offset＞
    * PSYNC 主服务器返回3种回复
        * 如果主返回+FULLRESYNC runid offset，那么表示主将与从执行完整重同步操作
        * 如果主返回+CONTINUE回复，那么表示主将与从执行部分重同步操作
        * 如果主返回-ERR回复，那么表示主的版本低于Redis 2.8
        
## 16章 sentinel 哨兵模式
- 哨兵模式
    * 哨兵是 redis 的高可用解决方案
    * 一个或多个 哨兵实例组成哨兵系统，监控多个主从
    * 发现主服务器下线时，将某个从升级为主
    * sentinel 向多个从发送 复制 指令，故障转移完毕
    * 之前掉线的主恢复上线时，设置为从
- 哨兵模式的工作流程
    * 1 启动初始化 sentinel
        * 1.1 初始化服务器，sentinel 是一个运行在特殊环境下的 redis 服务
        * 1.2 sentinel 服务与 redis 服务工作不一样,初始化流程也不一样
        * 1.3 将 redis 服务变成 sentinel 服务，sentinel 模式下，无法执行 set get 命令
        * 1.4 初始化 sentinel 状态下的 master 属性，记录了主服务器地址
        * 1.5 连接到 主，成为主的客户端，用来发送命令
    * 2 获取 主服 信息
        * 2.1 定时通过发送 INFO 命令到主来获取主服务器的信息
        * 2.2 主返回的信息包括主自己的信息，还有主下面的从服务器的地址状态等信息
    * 3 获取 从服 信息
    * 4 sentinel 通过 命令连接 发送信息到redis 服务器频道，通过 订阅连接 从 redis 服务器频道接受信息
