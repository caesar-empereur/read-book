## 15章 复制
#### Redis的复制功能分为 **[同步sync](#同步sync)** 和 **[命令传播](#命令传播)** 两个操作
* **[同步](#同步)** 操作用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态
    
    * 1 从服务器向主服务器发送SYNC命令
    * 2 收到SYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件
    * 3 将BGSAVE命令生成的RDB文件发送给从服务器
    * 4 从服务器将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态。


- **[命令传播](#命令传播)** 操作则用于同步操作后致主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态。

    * 1 主服务器数据变化后，会将自己执行的写命令发送给从服务器执行
    * 2 当从服务器执行了相同的写命令之后，主从服务器将再次回到一致状态

- **[旧版同步操作缺陷](#旧版同步操作缺陷)**

    * 1 主从同步过一次后断线再进行同步，会执行上一步的同步的内容(没有必要，需要的是需要同步断线后主服务器变动的数据)
    * 2 sync 操作耗时耗资源，需要主 执行 BGSAVE生成RDB文件，传输给从，消耗CPU内存磁盘资源
    * 3 从服务器接受到RDB文件后载入RDB文件，这时服务器会阻塞，无法处理客户端请求


> Redis从2.8版本开始，使用 **[PSYNC](#PSYNC)** 命令代替SYNC命令来执行复制时的同步操作

- **[PSYNC](#PSYNC)** 命令具有 **[完整重同步](#完整重同步)** 和 **[部分重同步](#部分重同步)** 两种模式

    * 完整重同步用于处理初次复制情况：完整重同步和SYNC命令的执行一样，都是通过让主服务器创建并发送RDB文件
    * 部分重同步则用于处理断线后重复制情况：主从断开后, 主服务器将连接断开期间主执行的写命令发送给从服务器，从服务器只要接收并执行这些写命令
    * **[部分重同步的原理](#部分重同步的原理)**
        * 主服务器和从服务器会分别维护一个复制偏移量
        * 主服务器每次向从服务器传播N个字节的数据时，就将自己的复制偏移量的值加上N
        * 从服务器每次收到主服务器传播来的N个字节的数据时，就将自己的复制偏移量的值加上N
- PSYNC 命令的实现
    * PSYNC 从服务器 命令的调用方法有两种
        * 如果从服务器以前没有复制过任何主服务器, 从服务器在开始一次新的复制时将向主服务器发送PSYNC -1
        * 如果从已经复制过某个主，那么从在开始新的复制时将向主发送PSYNC ＜runid＞ ＜offset＞
    * PSYNC 主服务器返回3种回复
        * 如果主返回+FULLRESYNC runid offset，那么表示主将与从执行完整重同步操作
        * 如果主返回+CONTINUE回复，那么表示主将与从执行部分重同步操作
        * 如果主返回-ERR回复，那么表示主的版本低于Redis 2.8
