## SpringCloud 几个组件

- Config (配置中心)
- Bus (消息总线)
- Ribbon (负载均衡)
- Hystrix (断路器)
- Zuul (网关权限过滤)
- OpenFeign (服务调用，集成Ribbon, Hystrix)
- Sleuth (链路监控)
- Zipkin (链路监控可视化)
- Eureka, Consul 集群自愈扩容

## 微服务注册发现的过程

- 启动注册中心，consul eureka
- 服务的调用方，提供方都把自己的服务id, ip, 端口信息注册到注册中心
- 注册过程是通过 http 接口实现的，注册中心把信息服务信息存到一个类似 map 的容器中
- 消费者可以从注册中心中找需要调用的服务的地址信息，缓存到本地
- 拿到地址信息后，消费者使用一定的客户端负载策略对提供方发起调用
- 每个服务的地址变更后，会重新注册
- 每个服务缓存到本地的其他服务信息会定时从注册中心拉取更新
- 注册中心跟每个服务保持心跳机制，心跳不在线的会在注册列表里剔除

```
注册中心：consul, eureka, zookeeper, etcd, nacos
```

## 脑裂问题
- 脑裂(split-brain)就是“大脑分裂”，也就是本来一个“大脑”被 **[拆分了两个或多个大脑]()**
- 脑裂通常会出现在 **[集群环境]()** 中 ，consul、Zookeeper集群，而这些集群环境有一个统一的特点，就是它们有一个大脑
- 在 **[多个分区数据中心]()** 之间是由 **[网络](#)** 连接保持心跳，并且要同步分区之间的数据 **[一致性]()** 的
- 分区的 **[网络断开]()** 后，每个分区自己单独选举出来一个领导，或者只处理自己分区的数据，就会与另外的分区 **[数据不一致]()**
- 因此在领导选举的时候有 **[过半选举机制](#)**，确保其他分区能正常通信，保持数据一致性

## feign 问题总结
- feign 的远程调用资源隔离模式
    - feign 的远程调用有2种，包括 线程隔离，信号量隔离
    - 线程隔离就是新建异步线程，信号量隔离就是使用当前线程远程调用
    - feign 默认的就是线程隔离模式
- feign 的断路器 hystrix 开启后，调用线程为异步线程的问题
    - 描述
    ```
    feign 的 fallback 断路器要生效的话, 必须开启配置项 hystrix.feign.enable=true。
    但是该配置开启后远程调用的时候会启动新的异步线程，导致 ThreadLocal 无法传递
    
    ```
    - 解决方法 1
        - 开启 hystrix.shareSecurityContext=true 配置，开启线程共享上下文，会使用信号量隔离模式
    - 解决方法 2
        - 注册一个配置为信号量隔离模式的bean, 并且 FeignClient 指定 configuration=该bean，也会使用信号量隔离模式
    - 解决方法 3
        - 使用默认的线程隔离模式，对子线程调用进行封装，在2个线程中实现传递上下文信息的逻辑
    - 使用 InheritableThreadLocal 传递父线程的变量到子线程
