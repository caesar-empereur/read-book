## Raft 算法

- raft是工程上使用较为广泛的 **[强一致性、基于leader、高可用的分布式协议]()**
- raft是一个 **[共识算法]()**，所谓共识，就是多个节点对某个事情达成一致的看法
- 在部分 **[节点故障]()**, **[网络延时]()**, **[网络分割]()**的情况下用于提高系统的**[容错性]()**
- 它将一致性分解为多个子问题
    - **[Leader选举]()**
    - **[日志同步]()**
    - **[日志压缩]()**
    - **[成员变更]()**
- Raft将系统中的角色分为领导者（Leader）、跟从者（Follower）和候选人（Candidate）

- Raft要求系统在任意时刻 **[最多只有一个Leader]()**，正常工作期间只有Leader和Followers

## Leader选举

- 多个节点在启动过程中会进行选举，产生一个leader
    - n 个节点的集群中，每个节点会保存一份初始化的节点名单，随机选取一个，广播到其他节点
    - 每个节点都广播一次自己的选举，n 次广播过后，每个节点能得到一份投票结果，票数最多的节点设置自己为 leader
    - 得到最多的票数必须大于 n 个节点的一半数量，这叫 **[过半选举]()**
- leader 产生之后定期向所有followers发送心跳信息维持其统治
- 如果 follower 定期没有收到 leader 的心跳，会认为leader已经断或者挂掉，会重新发起一次选举
- 在一个分区的网络里面，如果 A 区与 B 区断开了，发起选举同样要过半才成功，否则2个分区2个leader 会导致一致性问题
    - 这时候的选举的条件是只有 **[带有最新一条日志编号的 follewer 才有资格选举]()**
    - 选举需要每个节点广播的时候带上自己最新的一条日志编号，**[其他节点进行编号比对，如果比自己的旧，拒绝选举]()**

## 日志同步
- Leader：接受客户端请求，并向Follower同步请求日志，当日志同步到大多数节点上后告诉Follower提交日志。
- Follower：接受并持久化Leader同步的日志，在Leader告之日志可以提交之后，提交日志。
- 日志被复制到大部分 follower 上，leader返回客户端处理成功
- 一般情况下，Leader和Followers的日志保持一致
- Leader崩溃可能会导致日志不一致
- 一个Follower可能会丢失掉Leader上的一些条目，也有可能包含一些Leader没有的条目
- **[Leader通过强制Followers复制它的日志]()** 来处理日志的不一致，Followers上的不一致的日志会被Leader的日志覆盖
- **[每条日志是由大小编号的]()**，用来标记日志的先后顺序，比较不同节点的最新日志是否一致


## 成员变更
- 成员变更是在集群运行过程中副本发生变化，如增加/减少副本数、节点替换等
- 对于某个副本节点挂掉掉线的情况，leader会删除改节点，并且把 成员配置 同步到其他节点，其他节点更新配置
- 增加节点请求到 leader，leader 会产生新的成员配置同步到其他节点，其他节点把新日志应用到自己更新

## Raft 与 Paxos 的对比
| 对比项 | Raft |Paxos |
|:------|:-----|:-----|
| 复杂度 | 简单，伪代码级别的描述 | 大部分在理论|
| 安全性 | 有成员变更机制 | 没有|
| 日志 | 保证连续性 | 可以有空洞| 
