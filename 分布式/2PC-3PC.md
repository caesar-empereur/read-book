### 数据库事务需要满足的条件

- 原子性（Atomicity）指事务作为整体来执行，要么全部执行，要么全不执行。
- 一致性（Consistency）指事务应确保数据从一个一致的状态转变为另一个一致的状态。
- 隔离性（Isolation）指多个事务并发执行时，一个事务的执行不应影响其他事务的执行。
- 持久性（Durability）指已提交的事务修改数据会被持久保存。

### 数据库事务的实现
- **[事务的 ACID 是通过 InnoDB 日志和锁来保证]()**
- **[事务的隔离性是通过数据库锁的机制实现]()**
- **[持久性通过 Redo Log（重做日志）来实现]()**
- **[原子性和一致性通过 Undo Log 来实现]()**

### **[分布式事务--2PC]()**
- 2PC的方案
  - 2PC指的是第一阶段 prepare 事务预处理(事务执行)，第二阶段 commit 提交事务
  - 2PC由2部分组成，一个事务协调者(分布式事务的中心)，一个事务参与者(应用的本地事务)
  - 协调者发出事务执行请求，参与者根据执行结果返回对应的信息，协调者进行下一步的操作指令
  - 只要有参与者返回第一阶段失败，则协调者会向所有参与者发出回滚的命令
- 2PC的缺陷
  
|**[2PC的缺陷]()**| **[解决办法]()**|
|----|-----|
|协调者单点故障|协调者的备份节点|
|协调者挂机导致事务锁住|参与者引入超时机制|
|**[有些参与者提交不成功导致不一致]()**|**[没法解决]()**|
- 2PC的主要问题就是协调者挂掉之后参与者无法做出选择，从而导致阻塞，参与者也没有超时导致资源锁住


### **[分布式事务--3PC]()**
```
最关键要解决的就是协调者和参与者同时挂掉导致数据不一致的问题，
所以 3PC 把在 2PC 中又添加一个阶段，这样三阶段提交就有：CanCommit、PreCommit 和 DoCommit 三个阶段
```
![3pc](https://github.com/caesar-empereur/read-book/blob/master/photo/distri/3pc.png)

- 3PC流程
  - PreCommit 阶段之后，参与者响应No,或者响应超时的话，协调者会发出中断事务的请求
  - 参与者接收到 abort 请求后，利用 undo 日志执行事务回滚，并在完成事务回滚后释放占用的资源
- 3PC的改进点
  - 3PC在第三阶段如果参与者没收到 doCommit 的请求，会默认前面2个阶段已经通过资源检查了
  - 相当于做出了更多了预留检查的动作，那么应该有更高的几率成功提交事务
  - 因此第三阶段如果没有收到提交请求的话，为了防止锁表，默认是会提交事务的
  - 但是 doCommit 时，出现部分参与者因为网络或者其他异常情况，没有提交，就会导致不一致
