- 数据库连接池优化
    - springboot 2.*之后 hikaricp 是默认的数据库连接池
    - 连接池各个参数的含义
        - **[max-poolsize]()**：连接池中的最大的连接数，包括池中和拿出来使用的
            - 默认是 10
            - **[连接池会试别数据库配置的最大连接数，最大连接数只会小于等于数据库最大连接数]()**
        - **[max-lifetime]()**：连接池中连接的最大的生存时间
            - (默认 30 分钟)，但是使用中的连接就算超时了也不会关掉
            - 配置的参数如果是小于 30秒 的，会被设置为默认的半小时
            - 代码里面判断到最大生存时间大于30分钟的话，每创建一个连接会启动一个对应时间的定时任务去关闭连接
            - 时间一到就会将连接关闭，重新创建一个连接，连接的关闭包括给连接打上标记，下次获取的时候会判断连接标记
            - 连接软关闭之前也会判断连接是否已经关闭，是的话就不操作了
        - **[connection-timeout]()**: 客户端从连接池获取连接等待的最大时间，超过时间就会抛异常
            - 默认是 30 秒
        - **[minimum-Idle]()**:此属性控制HikariCP尝试在池中维护的最小空闲连接数
            - HikariCP作者建议不要设置此值，而是允许HikariCP充当一个固定大小的连接池
            - minimumIdle未设置则默认为是maximum PoolSize
            - minimumIdle应始终小于或等于maximumPoolSize
        - **[idel-timeout]()**: 连接在池中保持空闲状态的最长时间
            - 默认是 10 分钟
            - 如果当前总连接数<最小空闲连接，则空闲连接不会退休
            - 该参数不是单独存在的，只有在最小空闲连接<最大连接数，空闲超时达到之后才会移除没使用的连接
            - 空闲的连接被移除之后，会重新创建新的连接放到池中
            - 空闲超时时间为 0 说明空闲的连接永远不会从连接池中移除
    - **[获取连接的过程]()**
        - 出现数据库操作，包括查询与插入，每次调用datasource方法的时候就会获取连接
        - 此时活跃连接数会增加1，空闲连接数会减去1，总连接数不变
    - **[归还连接的过程]()**
        - 方法里面调用数据库操作，方法当前的线程执行完成之后连接会归还到连接池
        - 如果当前方法所在的线程阻塞了，那么连接会一直占用
    - 连接数与TPS, QPS 关系
        - 数据库的 QPS = TPS*20, QPS = 连接数*3，这个数据是阿里云的数据库用 sysbentch 工具测试的
        - 要达到5W个数据库连接，大概需要 单机16000连接数，4WQPS的 3台
        ![tps-qps](https://github.com/caesar-empereur/read-book/blob/master/photo/tps-qps.png)
- **[连接池大小如何设置?]()**
    - 连接池的大小不是越大越好，而是小的恰到好处，**[连接池最大连接数 = mysql 最大并发查询数= mysql CPU核心数 * 2]()**
    - 连接池小的好处的原因是，单个查询 10ms，一个连接可以执行 100 qps, 10个连接就可以实现 1000 qps
    - 长时间事务的应用跟短时间事务的应用应该单独部署，这样连接池可以单独配置
    - 数据库连接数与应用连接池连接数，qps 之间的关系
        - 数据库的并发查询数跟活动连接数是一致的，查询线程跟数据库连接也是一一对应的
        - 在连接池最大连接数为1 的情况下，压测的应用的最大 qps=400
        - 在连接池最大连接数为10的情况下，压测的应用的最大 qps=2000
        - 在连接池最大连接数继续增大的情况下，压测的 qps 还是维持在 2000
        - 因此，在这个测试中，mysql 的最大并发查询是 2000 qps, 单个查询的时间为 2.5 ms
    - *[影响mysql qps, tps 的因素*]()**
        - mysql cpu 核心数，磁盘的 IOPS 性能
        - 4核心的mysql 最大并发(真正同时)查询/事务不会超过10
        - 单个查询/事务的执行时间有长有短，时间短的单位时间内一个cpu核心可以实现更多的查询/事务，称qps/tps更高
        - 单个查询/事务的执行时间跟cpu频率，还跟磁盘IOPS性能有关，IOPS高的，单个查询时间更短
        - 在一个连接内，同样的cpu核心，查询时间短的,qps/tps可以达到更高
        - 经过测试，连接池的最大连接数在(mysql最大并发查询数=mysql CPU核心数*2) 的时候qps最高，再继续增大qps不会增加了
    - mysql 连接数，线程数关系
        - show status like '%max_connections%'; 
        - show status like 'Threads%'
        ```
      Threads_cached    管理的线程池中还有多少可以被复用的资源
      
      Threads_connected 打开的连接数
      
      Threads_created   表示创建过的线程数，如果发现Threads_created值过大的话，表明MySQL服务器一直在创建线程，
                        这也是比较耗资源，可以适当增加配置文件中thread_cache_size值，查询服务器
      
      Threads_running   激活的连接数，这个数值一般远低于connected数值，准确的来说，Threads_running是代表当前并发数
        ```
- **[连接池异常问题分析]()**
    - Connection is not available, request timed out after 3000ms
        - 原因分析
            - 大量的数据库操作的请求线程没有结束，一直占用连接，没有归还到池中
            - 导致池中的连接数不够用，新的线程获取连接超时时间达到，因此抛出该异常
        - 应用出现的场景
            - 常见于并发量高的时候，数据库查询压力大，事务耗时太长，连接占用太多，部分请求报错
        - 场景复现
            - 设置连接池参数，最大连接数=3，获取连接超时时间=3秒
            - 方法里面数据库查询完后 sleep 5秒，大于获取连接超时时间
            - 启动10个线程去压测这个方法的接口
    - the driver has not received any package from the server
        - 原因分析
            - 一般发生在数据库的 wait_time_out < max-lifetime 的时候
            - 连接池中的连接被认为是存活的有效连接，但是数据库连接管理器已经将连接关闭了
        - 应用出现的场景
            - 一般出现在连接池参数与数据库参数配置不匹配的时候
        - 场景复现
            - 将以上2个参数配置一个大小关系
            - 执行一个慢查询达到数据库的连接超时时间
