- 促销缓存故障导致主链路中断一小时
```
促销的一个购物车分组功能，前端传门店编码，订单号，会员id，商品详情，返回
门店下的活动,以及活动对应的有哪些商品，可以购买的数量
另一个维度就是，这些商品对应的参与了哪些活动
门店下的每个活动有哪些可以加价换购的，换购的数量，条件
全场换购的商品


核心故障就是在根据门店编码获取所有进行的活动  这个逻辑
活动数据缓存有两个
一个是所有活动的列表缓存，在一个 key-list 结构中
一个每个活动单独的缓存数据，就是普通的 key-string 结构
首先是在缓存中查询出这个门店下面所有的活动列表
然后在 for 循环中在缓存里面查询 单个的活动信息，查询不到就从数据库查出来，更新到缓存


按理单个的活动缓存数据跟活动列表的数据应该是同时失效的，但是故障原因就是，单个的缓存是代码控制失效了
但是活动列表没有失效，因为运营操作的原因
活动列表的失效或者更新是要在运营后台操作的，平时是大促转点前运营会调整活动策略，让它失效或者保持更新
但是这一次要求运营大促前不能操作活动数据，失效的活动列表没有在缓存清理掉

因此最后就导致活动列表数据没有清理，进行 for 循环的逻辑，循环里面检查到单个活动缓存失效了，就去
数据库查(7  8 次查询)，失效的有10个活动，查库又是在for循环里面，流量一高，导致一个活动查库耗时很长(查询太多),
数据库负载变高，后续的请求进来查库导致更慢


一个请求线程里，前面获取的 redis 连接查数据，循环里面由于查库一直在等待，导致 redis 连接一直没有释放，
新进来的请求无法获取连接直接异常
```

- mongodb 修改索引忘记加后台处理导致锁表
```
线上的一个过亿数据的表，原先的某个索引是唯一索引，插入数据时有时候会出现值相同
导致插入报错，因此改成普通索引

改索引的语句忘记加上参数 background:true，出现半个小时的锁表
数据库的部署架构是主从模式的副本集, 一主一从还有另外一个隐藏节点

事发的时候正好的零点，想着流量不多，就执行了，结果0点的时候刚好促销那边有活动准时生效
导致优惠券领取大量异常，查看数据库发现数据库的负载持续很高，请求进来的查询一个接一个，
kill掉一些后另外一些又来了，导致主库崩掉，所有写入都异常了

因此赶紧联系运维，操作从库升级为主库，隐藏节点升级为从库，原来的主节点关闭所有连接

```

- redis 3.0集群模式 + haproxy 导致key 找不到的问题
```
redis 集群模式下, key 的定位过程
客户端发送一个key, 任意一个节点接到命令，发现 key 不在自己的节点上，会返回 moved 信息和重定向到哪个节点
客户端如果是单节点方式访问的话会直接把 moved 当成错误提示出来
客户端如果是集群模式访问的话会根据重定向的信息重新访问到对应的正确节点，不会打印错误

当时新应用上线了，运维给了一个 redis 的 ip 和端口(是一个虚拟 ip)，我以为是单节点的，实际上是集群模式的
前面还挂了个 haproxy，运维也没说，因此项目里面配置的连接方式 是单节点的

最后出现的问题是刚刚配置的一些基础数据，页面重新打开的时候一直报错
这些基础数据会写入到 redis，详情页面打开的时候会去 redis 获取，本质上就是 set 进去的 key  get不到了

就是因为客户端用的是单节点的访问方式，对集群的 key 重定向是无法处理的

背景
redis是在 3.0 之后加入了集群模式，在集群模式之前，是主从和哨兵模式，客户端对这种模式的访问需要
识别哪些节点是主，哪些是从，写数据定位到主，读数据定位到从，主从出问题的时候能执行主从切换，故障转义
需要客户端自己处理逻辑，只有 redisson, lecture 这种插件能支持，其他的是不支持的，故障转义得在服务端有
工具执行

因此有的运维用一些代理的中间件来处理，haproxy 在配置文件里面配置好识别主从节点
然后根据发送的命令判断是读还是写，负载均衡到对应的节点上，并且可以实现故障转义

这种方式在集群模式出来前是可以用的，但是集群模式出来后，haproxy 就没有存在的必要了，
客户端访问一个 key，出现重定向的时候，是直接跳过 haproxy 这个代理的中间件的，直接访问到对应的redis 节点
相当于 haproxy 是被直接跳过了，起不到代理作用
```
