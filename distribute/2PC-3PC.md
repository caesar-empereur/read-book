### 数据库事务需要满足的条件

- 原子性（Atomicity）指事务作为整体来执行，要么全部执行，要么全不执行。
- 一致性（Consistency）指事务应确保数据从一个一致的状态转变为另一个一致的状态。
- 隔离性（Isolation）指多个事务并发执行时，一个事务的执行不应影响其他事务的执行。
- 持久性（Durability）指已提交的事务修改数据会被持久保存。

### 数据库事务的实现
- **[事务的 ACID 是通过 InnoDB 日志和锁来保证]()**
- **[事务的隔离性是通过数据库锁的机制实现]()**
- **[持久性通过 Redo Log（重做日志）来实现]()**
- **[原子性和一致性通过 Undo Log 来实现]()**

### 分布式事务--2PC
- 组成：事务协调者与事务参与者（各种服务）
- 2PC的流程

![2pc](https://github.com/caesar-empereur/read-book/blob/master/photo/2pc.png)
### 2PC可能出现的问题
2PC在执行过程中可能发生协调者或者参与者突然宕机的情况，在不同时期宕机可能有不同的现象

情况 | 分析及解决方案
---|---
协调者挂了，参与者没挂 | 找一个替代的协调者，再询问参与者情况对应操作
协调者没挂，参与者挂了(无法恢复) | 统一回滚
协调者参与者第一阶段挂掉了 | 由于没有commit操作，新的协调者可以询问参与者，决定commot或者rollback,不会数据不一致
协调者参与者第二阶段挂掉了 | 新的协调者与参与者可以保持数据一致，但是参与者恢复之后，没有记住之前的状态，没人知道他做了什么，因此数据会不一致

### 分布式事务--2PC--总结
- **同步阻塞问题**
    - 从事务开始到提交，都是阻塞性的，占用公共锁，其他线程要操作，只能等待释放
- **单点故障**
    - 在第二阶段，协调者发生故障，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作
- **数据不一致**
    - 第二阶段种，协调者发出 commot 消息后，网络故障，只有一部分参与者接收到消息，没收到的无法继续事务，数据会不一致


### 分布式事务--3PC
```
最关键要解决的就是协调者和参与者同时挂掉导致数据不一致的问题，
所以 3PC 把在 2PC 中又添加一个阶段，这样三阶段提交就有：CanCommit、PreCommit 和 DoCommit 三个阶段
```
![3pc](https://github.com/caesar-empereur/read-book/blob/master/photo/3pc.png)

- 发送中断请求：
    - 协调者 向所有参与者节点发送 abort 请求；
    - 参与者接收到 abort 请求后，利用 undo 日志执行事务回滚，并在完成事务回滚后释放占用的资源；
    
    - 参与者在完成事务回滚之后，向 协调者 发送 ack 信息；
    - 协调者 接收到所有参与者反馈的 ack 信息后，中断事务。

```
3PC 虽然解决了 Coordinator 与参与者都异常情况下导致数据不一致的问题，
3PC 依然带来其他问题：比如，网络分区问题，在 preCommit 消息发送后突然两个机房断开，
这时候 Coordinator 所在机房会 abort, 另外剩余参与者的机房则会 commit。
```
