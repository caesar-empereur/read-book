## nginx 灰度发布项目

#### 项目大致介绍

- 背景：一种常见的应用灰度发布的实现
```
一个线上的应用部署有 4台服务器，nginx 做了负载均衡，策略可能为 ip_hash，轮询，权重，最少连接之类的。
每次的请求可能分发到不同的服务器

在应用发布的时候，先把 发布的文件部署到一台服务器上，并且把这台服务器设置为内部访问，nginx 这时把
这台服务器不加入到负载均衡里面，线上的流量只访问到其他3台节点。测试人员通过内部ip访问到这台新发布应用的
节点，在测试完成之后就把这台服务器重新加入到负载均衡里面。

以上的工作都是运维完成的，相当于重复的工作

```

- 灰度发布的重点在于在不重启 nginx 的情况下进行节点的上下线以及动态扩容

- 灰度发布系统需要的功能
    - 1 维护一个服务的负载均衡有几个节点，每个节点的IP，端口
    - 2 页面可以动态增加或者减少负载的节点，实时刷新到 nginx 的upstream里面
    - 3 页面可以对某一个服务的某个节点的信息如ip, 端口变更，变更后刷新到 nginx 的upstream里面
    - 4 当需要发布应用时，在页面先把一个节点从应用负载里面移除，然后发到这个节点，进行线上验证
    - 5 该节点验证没问题后，在页面把该节点重新加入负载均衡
    - 6 以上操作就是实现了在一个页面动态的调整一个服务的负载均衡节点

- 方案
    - 1 利用lua中 "lua_shared_dict" 指令开辟一个共享内存空间，所有进程都可访问
    - 2 该指令需要 lua_nginx_module 模块, 在http模块内、server模块外使用
    - 3 

- 方案需要的工具
    - 1 nginx
    - 2 luajit 环境
    - 3 lua_nginx_module 这个模块
    - 4 mysql 环境
    - 5 节点信息的维护页面接口需要一个后台，可用 springboot 或者 beego
    
- 方案开搞步骤

    - 1 方案需要的运行环境为 nginx 或者 openresty, 并且需要这2个软件能动态添加模块
    - 2 windos 环境下的这2个软件是执行文件，无法添加模块，因此只能在 linux 环境下开搞
    - 3 nginx 添加依赖的模块
        - ./configure --add-module=D:\dev\app\nginx\module\ngx_devel_kit-0.3.1 --add-module=D:\dev\app\nginx\module\lua-nginx-module-0.10.16rc5
        
lua 测试 403 需要管理员模式启动命令行 tasklist /fi “imagename eq nginx.exe”
taskkill /f /pid {pid} 把对应 pid 的nginx 干掉，脚本干掉nginx 进程可能会有一些无法 kill，是命令行权限问题
